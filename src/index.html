<!DOCTYPE html>
<html>

    <!-- HTML page head -->
    <script src="templates/head.tpl.html" data-include data-vars='{"root": "."}'></script>

    <body>

        <!-- Map section -->
        <div id="vmap"></div>

        <!-- Map legend -->
        <img id="vmap-legend" src="static/infection_scale.png" />

        <!-- Setup map data -->
        <script>

            loadData(data => {

                const countryNames = data.world.reduce((dict, row) => {
                    dict[row.CountryCode] = row.CountryName;
                    return dict;
                }, {});

                const infectionRate = data.world.reduce((dict, row) => {
                    const maxInfected = 1E6;
                    const confirmed =
                        Math.max(1.0, Math.min(maxInfected, parseFloat(row['Confirmed'])));
                    const ratio = confirmed / maxInfected;
                    const logRatio = Math.log10(confirmed || 0.0) / Math.log10(maxInfected);
                    dict[row['CountryCode'].toLowerCase()] = logRatio || 0.0;
                    return dict;
                }, {null: 1.0});

                $('#vmap').vectorMap({
                    map: 'world_en',
                    values: infectionRate,
                    selectedColor: null,
                    backgroundColor: '#424242',
                    scaleColors: ['#FFFFFF', '#FF0000'],
                    normalizeFunction: null,
                    onRegionSelect: (event, code, region) => {
                        code = code.toUpperCase();
                        const name = countryNames[code];

                        // Early exit: If there is no data available
                        if (!data.charts[code]) {
                            alert(`No data available for ${name || code}`);
                            return;
                        }

                        // If this is a touch input device, ask for confirmation
                        if ('ontouchstart' in window && !confirm(`See data for ${name}?`)) return

                        const chartImage = data.charts[code][Object.keys(data.charts[code])[0]];
                        window.open(`report/?countryCode=${code}`, '_blank')
                    }
                });
            });
        </script>

        <!-- Load analytics at the end of the page -->
        <!-- <script src="templates/analytics.tpl.html" data-include></script> -->
    </body>
</html>