<!-- Wrap the whole widget into a DIV -->
<div style="visibility: hidden;">

    <script async>

        (async function () {
            const minRows = 1;
            const columns = [
                'country_name',
                'subregion1_name',
                'subregion2_name',
                'locality_name',
            ];
            const rootElement = document.currentScript.parentElement;

            // Get the location key from the URL
            const locationKey = new URLSearchParams(location.search).get('key');

            // Load the location data using the location key
            let locationData = await loadCSV(`${CURRENT_OPTIONS['cod-data-url']}/${locationKey}/main.csv`);

            // Early exit: there is not enough relevant data for this chart
            // NOTE: Using `some` since we want to display this table with a subset of data too
            if (locationData.filter(row => columns.some(col => row[col] && row[col] !== '')).length < minRows) {
                console.error('Not enough records found for columns:', columns);
                rootElement.style.display = 'none';
                return;
            }

            // Create a new element to hold the data and add it to the page
            const elem = attachElement('h1', { className: 'centered' }, rootElement, prepend = true);
            elem.style.paddingLeft = '64px;';
            elem.style.paddingRight = '64px;';

            // Fill the elements with data
            const metadata = locationData[0];
            const locationLabel = lvl => {
                if (lvl === '0') return metadata.country_name;
                else if (lvl === '1') return metadata.subregion1_name;
                else if (lvl === '2') return metadata.subregion2_name;
                else if (lvl === '3') return metadata.locality_name;
                else return `Unknown`;
            }
            elem.innerText = locationLabel(metadata.aggregation_level);

            // Unhide element
            elem.parentElement.style.visibility = 'visible';

        })();
    </script>
</div>