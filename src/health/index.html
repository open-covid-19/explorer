<!DOCTYPE html>
<html>

<!-- HTML page head -->
<script src="../templates/head.tpl.html" data-include data-vars='{"root": ".."}'></script>

<!-- Google Charts -->
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

<script type="text/javascript">

    let chartLoaded = false;
    const pendingCallbacks = [];
    window.chart = function (callback) {
        if (chartLoaded) retryCallback(callback);
        else pendingCallbacks.push(callback);
    }

    google.charts.load('current', {
        'packages': ['corechart', 'bar', 'sankey', 'table'], 'callback': () => {
            chartLoaded = true;
            pendingCallbacks.forEach(callback => retryCallback(callback));
        }
    });
</script>

<style>
    .table-wrapper {
        max-height: 400px;
        overflow-y: auto;
    }
</style>

<body class="single-column">

    <!-- Header with links -->
    <script src="../templates/header.tpl.html" data-include data-vars='{"root": ".."}'></script>

    <main>
        <!-- Title of the report -->
        <h1 id="health-title" class="centered">COVID-19 Data Health Dashboard</h1>

        <!-- Create a selector with each data table -->
        <p class="justify">
            See below for a list of tables. Click on the table name for more details. Refer to the
            <a href="https://github.com/open-covid-19/data">documentation</a> for a description of
            each field.
        </p>

        <table id="table-list" class="fullwidth"></table>

        <div class="spacer"></div>

        <h2 id="table-subsection" class="centered">
            </h1>

            <div class="table-wrapper">
                <table id="table-metadata" class="fullwidth"></table>
            </div>
            <div id="country-coverage-chart" style="display: inline-block;"></div>
            <div id="admin-level-chart" style="display: inline-block;"></div>
            <div id="null-analysis-chart" class="fullwidth" style="padding-bottom: 2em;"></div>

            <!-- Load all the data -->
            <script>
                window.data = {};

                $('#table-list').html([
                    `<tr><th>Table Name</th><th>Date Range</th><th>Column Count</th></tr>`
                ].concat(Object.keys(OPEN_COVID_CONFIG['tables']).map(tableKey => {
                    const tableName = OPEN_COVID_CONFIG['tables'][tableKey];
                    return `<tr data-value="${tableKey}"><td>${tableName}</td><td colspan=2>Loading...</td></tr>`;
                })));

                function onTableSelected(tableKey) {
                    const table = window.data[tableKey];
                    const tableName = OPEN_COVID_CONFIG['tables'][tableKey];

                    // Add the subsection title
                    $('#table-subsection').text(tableName);

                    // Create the metadata table
                    $('#table-metadata').html([
                        `<tr><th>Column Name</th><th>Type</th><th>Last Non-Null Value</th></tr>`
                    ].concat(table.columns.map((column, idx) => {
                        const nonnull = table.data.filter(row => row[idx]);
                        if (nonnull.length > 0) {
                            const lastValue = nonnull[nonnull.length - 1][idx];
                            let valueType = typeof lastValue;
                            if (Number.isInteger(lastValue)) {
                                valueType = 'int';
                            } else if (valueType === 'number') {
                                valueType = 'double';
                            }
                            return `<tr><td>${column}</td><td>${valueType}</td><td>${lastValue}</td>`;
                        } else {
                            return `<tr><td>${column}</td><td>null</td><td>null</td></tr>`;
                        }
                    })));

                    // Country coverage for this table
                    chart(() => {
                        const keyIdx = table.columns.indexOf('location_key');
                        const countries = table.data.map(row => row[keyIdx].split('_')[0]);
                        const countryCounts = countries.reduce((counts, country) => {
                            counts[country] = counts[country] || 0;
                            counts[country] += 1;
                            return counts;
                        }, {});

                        const chartData = google.visualization.arrayToDataTable(
                            [['Country', 'Record Count']].concat(Object.keys(countryCounts).map(x =>
                                [x, countryCounts[x]]).sort((a, b) => b[1] - a[1])));

                        const elem = document.getElementById('country-coverage-chart');
                        new google.visualization.PieChart(elem).draw(chartData, {
                            title: `Coverage by Country`,
                            width: 500,
                            height: 400,
                            pieHole: 0.3,
                        });
                    });

                    // Visualize the admin level of the data
                    chart(() => {
                        const keyIdx = table.columns.indexOf('location_key');
                        const adminLevel = table.data.map(row => row[keyIdx].split('_').length - 1);
                        const adminLevelCounts = adminLevel.reduce((counts, level) => {
                            counts[level] += 1;
                            return counts;
                        }, { 0: 0, 1: 0, 2: 0 });
                        const adminLevelTable = google.visualization.arrayToDataTable([
                            ['Admin Level', 'Record Count'],
                            ['Country', adminLevelCounts[0]],
                            ['State/Province', adminLevelCounts[1]],
                            ['County/Municipality', adminLevelCounts[2]],
                        ]);

                        const elem = document.getElementById('admin-level-chart');
                        new google.visualization.PieChart(elem).draw(adminLevelTable, {
                            title: `Coverage by Admin Level`,
                            width: 500,
                            height: 400,
                            pieHole: 0.3,
                        });
                    });

                    // Visualize the null vs non-null elements
                    chart(() => {
                        const nndata = new google.visualization.DataTable();
                        nndata.addColumn('string', 'Column');
                        nndata.addColumn('string', 'Value');
                        nndata.addColumn('number', 'Records');

                        const nrows = [];
                        table.columns.forEach((column, idx) => {
                            const ncount = table.data.filter(row => row[idx] == null).length;
                            nrows.push([column, 'null', ncount]);
                            nrows.push([column, 'non-null', table.data.length - ncount]);
                        })
                        nndata.addRows(nrows);

                        const elem = document.getElementById('null-analysis-chart');
                        if (nrows.length > 20) {
                            new google.visualization.Table(elem).draw(nndata, {
                                width: '100%',
                                height: '400px',
                                cssClassNames: { headerRow: 'google-charts-column-header' },
                            });
                        } else {
                            new google.visualization.Sankey(elem).draw(nndata, { height: '400px' });
                        }
                    });

                }

            </script>

            <script async>
                // Load data in the background
                Object.keys(OPEN_COVID_CONFIG['tables']).forEach(async tableKey => {
                    const tableName = OPEN_COVID_CONFIG['tables'][tableKey];

                    // Skip tables that make the client crash during parsing
                    if (['by-age', 'weather', 'google-search-trends'].includes(tableKey)) {
                        $(`tr[data-value=${tableKey}]`).html(
                            `<td>${tableName}</td><td colspan=2>Table too large to load</td>`);
                        return;
                    }

                    let table;
                    const url = `${OPEN_COVID_CONFIG['data-url']}/v3/${tableKey}.json`;
                    try {
                        table = await loadJSON(url);
                    } catch (exc) {
                        console.error(exc);
                        $(`tr[data-value=${tableKey}]`).html(
                            `<td>${tableName}</td><td colspan=2>Error Loading</td>`);
                        return;
                    }
                    window.data[tableKey] = table;
                    let dateRange = 'Static';
                    if (table.columns.includes('date')) {
                        let minDate = '2020-01-01';
                        let maxDate = moment().format('YYYY-MM-DD');
                        const dateIndex = table.columns.indexOf('date');
                        const allDates = table.data.map(x => x[dateIndex]).sort();
                        const firstDate = allDates[0];
                        const lastDate = allDates.slice(-1)[0];
                        if (firstDate > minDate) minDate = firstDate;
                        if (lastDate < maxDate) maxDate = lastDate;
                        dateRange = `${minDate} â€“ ${maxDate}`;
                    }
                    $(`tr[data-value=${tableKey}]`).html(
                        `<td><a href="#table-subsection" onclick="onTableSelected('${tableKey}')">${tableName}</a></td>
                        <td>${dateRange}</td>
                        <td>${table.columns.length}</td>
                    `);
                    console.log(`${tableName} table loaded successfully`);
                });
            </script>
    </main>

    <!-- Load analytics at the end of the page -->
    <script src="../templates/analytics.tpl.html" data-include></script>
</body>

</html>