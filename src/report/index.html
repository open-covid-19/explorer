<!DOCTYPE html>
<html>

    <!-- HTML page head -->
    <script src="../templates/head.tpl.html" data-include data-vars='{"root": ".."}'></script>

    <body>

        <main>
            <!-- Title of the report -->
            <h1 id="report-title" class="centered"><span class="_name"></span> COVID-19 Data</h1>

            <!-- First report chart image -->
            <img id="report-chart-image" class="fullwidth" src="../static/transparent.png" />

            <!-- Summary of the report: more cases expected -->
            <p id="report-summary-more" class="mdpadding justify" style="display: none;">
                The forecast shows an expected increase in number of confirmed COVID-19 cases to a total
                of <b><span class="_confirmed"></span> (+<span class="_percent"></span>%)</b> over the
                next <span class="_days"></span> days.
            </p>

            <!-- Summary of the report: same cases expected -->
            <p id="report-summary-same" class="mdpadding justify" style="display: none;">
                The forecast shows an expected roughly equal number of confirmed COVID-19 cases over the
                next <span class="_days"></span> days.
            </p>

            <!-- Footnote of the report -->
            <p id="report-summary-footnote" class="mdpadding justify" style="font-size: small;">
                NOTE: The dates in the data may be delayed by one day. Please see the
                <a href="../about/">about page</a> for more information.
            </p>

            <!-- Setup report data -->
            <script>

                loadData(data => {
                    const code = URLSearchParameters().countryCode;
                    const codeFilter = row => row.CountryCode === code;
                    const latest = data.world.filter(codeFilter);
                    const forecast = data.forecasting.filter(codeFilter);
                    const chartUrl = `${OPEN_COVID_19_URL}/forecasting/${forecast[0].ForecastChart}`;

                    const recordedLast = latest.map(row => row.Confirmed)[latest.length - 1];
                    const estimatedLast = forecast.map(row => row.Estimated)[forecast.length - 1];
                    const totalIncrease = estimatedLast - recordedLast;
                    const percentIncrease = 100 * (totalIncrease / recordedLast);
                    const estimatedDays = forecast.filter(row => row.Confirmed === null).length;

                    console.log(forecast)

                    if (percentIncrease < 1) {
                        $('#report-summary-same').show();
                    } else {
                        $('#report-summary-more').show();
                    }

                    $('#report-chart-image').attr('src', chartUrl);
                    $('._name').each(function() { $(this).text(latest[0].CountryName) });
                    $('._days').each(function() { $(this).text(estimatedDays) });
                    $('._percent').each(function() { $(this).text(percentIncrease.toFixed(2)) });
                    $('._confirmed').each(function() { $(this).text(estimatedLast.toFixed(0)) });
                });
            </script>
        </main>

        <!-- Footer with links -->
        <script src="../templates/footer.tpl.html" data-include data-vars='{"root": ".."}'></script>

        <!-- Load analytics at the end of the page -->
        <script src="../templates/analytics.tpl.html" data-include></script>
    </body>
</html>