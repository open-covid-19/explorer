<!DOCTYPE html>
<html>

<!-- HTML page head -->
<script src="../templates/head.tpl.html" data-include data-vars='{"root": ".."}'></script>

<!-- Google Charts -->
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript">

    let chartLoaded = false;
    const pendingCallbacks = [];
    window.chart = function (callback) {
        if (chartLoaded) retryCallback(callback);
        else pendingCallbacks.push(callback);
    }

    google.charts.load('current', {
        'packages': ['corechart', 'bar'], 'callback': () => {
            chartLoaded = true;
            pendingCallbacks.forEach(callback => retryCallback(callback));
        }
    });
</script>

<body class="single-column">

    <!-- Header with links -->
    <script src="../templates/header.tpl.html" data-include data-vars='{"root": ".."}'></script>

    <div class="spacer"></div>

    <!-- Location search bar -->
    <script src="../templates/searchbar.tpl.html" data-include data-vars='{"url-prefix": ""}'></script>

    <main>

        <!-- Title of the report -->
        <h1 id="report-title" class="centered"><span class="_name">COVID-19 Data</span></h1>

        <div id="report-confirmed">
            <h3 class="centered">New Confirmed Cases</h3>
            <p id="no-new-confirmed" class="justify" style="display: none;">
                There are no new confirmed COVID-19 cases reported in the last
                <b><span class="_window_size"></span></b> days. The total number of
                confirmed cases <b><span class="_confirmed_curr"></span></b>. The first
                reported case was on <b><span class="_confirmed_first"></span></b>.
            </p>
            <p id="confirmed-summary" class="justify">
                The last reported number of cumulative confirmed COVID-19 cases is
                <b><span class="_confirmed_curr"></span></b>, which is a difference of
                <b>+<span class="_confirmed_diff"></span></b> from the previous day. The first
                reported case was on <b><span class="_confirmed_first"></span></b>.
            </p>
            <div id="confirmed-chart" class="fullwidth">
                <img src="../static/transparent.png" height="500px" />
            </div>
            <div class="spacer"></div>
        </div>


        <div id="report-rolling-confirmed">
            <h3 class="centered"><span class="_rolling_window"></span>-Day Cumulative Cases</h3>
            <p id="no-new-confirmed" class="justify" style="display: none;">
                There are no new confirmed COVID-19 cases reported in the last
                <b><span class="_confirmed_records"></span></b> days.
            </p>
            <p class="justify">
                This chart shows the cumulative number of confirmed COVID-19 cases over the last
                <b><span class="_rolling_window"></span></b> days. It represents an approximation
                for the number of active cases in this location.
            </p>
            <div id="rolling-confirmed-chart" class="fullwidth">
                <img src="../static/transparent.png" height="500px" />
            </div>
            <div class="spacer"></div>
        </div>


        <div id="report-deaths">
            <h3 class="centered">New Fatalities</h3>
            <p id="no-new-deaths" class="justify" style="display: none;">
                There are no new fatalities associated with COVID-19 reported in the last
                <b><span class="_window_size"></span></b> days. The total number of fatalities
                is <b><span class="_deaths_curr"></span></b>. The first
                reported fatality was on <b><span class="_deceased_first"></span></b>.
            </p>
            <p id="deaths-summary" class="justify">
                The latest reports claim a cumulative death toll related to COVID-19 of
                <b><span class="_deaths_curr"></span></b>, which is an increase of
                <b>+<span class="_deaths_diff"></span></b> since the previous day. The first
                reported fatality was on <b><span class="_deceased_first"></span></b>.
            </p>
            <div id="deaths-chart" class="fullwidth">
                <img src="../static/transparent.png" height="500px" />
            </div>
            <div class="spacer"></div>
        </div>


        <div id="report-mobility" style="display: none;">
            <h3 class="centered">Mobility Report</h3>
            <p class="justify">
                The following chart is a condensed view of
                <a href="https://www.google.com/covid19/mobility/" target="_blank">Google's
                    Mobility Report</a> for <span class="_name"></span>. It represents the change
                in movement aggregated across Google Maps users for certain categories compared
                to the average.
            </p>
            <div id="mobility-chart" class="fullwidth"></div>
            <div class="spacer"></div>
        </div>

        <div id="report-demographics" style="display: none;">
            <h3 class="centered">Demographics</h3>
            <table id="table-demographics" style="margin: auto;"></table>
            <div class="spacer"></div>
        </div>


        <!-- Setup report data -->
        <script>
            const key = URLSearchParameters().key;
            const dataFilter = row => row.key === key;
            const sub = (klass, text) =>
                $(`._${klass}`).each(function () { $(this).text(text) });

            const prettyPrintNumber = (num) => num ? num.toLocaleString() : "n/a";

            const minLength = 7;
            const windowSize = 21;
            const clientWidth = document.querySelector('main').getBoundingClientRect().width;
            const chartHeight = Math.min(480, Math.max(224, Math.round(clientWidth * 2 / 3)));
            sub('window_size', windowSize);

            loadData([`${key}/main`], (name, table) => {
                const records = tableToRecords(table);
                console.log(records)

                onIndexLoaded(records[0]);
                onEpidemiologyLoaded(records);
                onMobilityLoaded(records.map(row =>
                    Object.assign({}, Object.keys(row).reduce((acc, col) =>
                        col.indexOf('mobility') === -1 ? acc : Object.assign(acc, { [col]: row[col] }), { date: row.date })
                    )
                ).filter(row =>
                    Object.keys(row).reduce((acc, col) =>
                        col === 'date' ? acc : acc || row[col], false))
                );

                // Load the demographics table to get all the columns that belong there
                loadData(['latest/demographics'], (name, table) => {
                    const sample = records[0];
                    const demographicsColumns = Object.keys(tableToRecords(table)[0]);
                    onDemographicsLoaded(demographicsColumns.reduce((acc, col) =>
                        col === 'key' || sample[col] === null
                            ? acc
                            : Object.assign(acc, { [col]: sample[col] }), {})
                    );
                });
            });

            function onIndexLoaded(index) {
                switch (index.aggregation_level) {
                    case 0:
                        sub('name', `${index.country_name}`);
                        break;
                    case 1:
                        sub('name', `${index.subregion1_name}, ${index.country_code}`);
                        break;
                    case 2:
                        sub('name', `${index.subregion2_name}, ${index.subregion1_code} ${index.country_code}`);
                        break;
                    case 3:
                        sub('name', `${index.locality_name}, ${index.subregion1_code} ${index.country_code}`);
                        break;
                }
            }

            function onEpidemiologyLoaded(epi) {

                // Extract all the new confirmed cases for this data
                const confirmedRecords = epi
                    .filter(row => row.new_confirmed !== null);

                // Hide the section part altogether if we don't have data
                const confirmedRecordCount = confirmedRecords.length;
                if (confirmedRecordCount < minLength) {
                    console.log('Confirmed report not available');
                    $('#report-confirmed').hide();

                } else {
                    // Fill out confirmed-related data
                    const first = epi.filter(
                        row => row.new_confirmed > 0 || row.total_confirmed > 0)[0] || {};
                    const latest = epi.filter(
                        row => row.total_confirmed || row.new_confirmed).slice(-1)[0] || {};
                    sub('confirmed_curr', prettyPrintNumber(latest.total_confirmed));
                    sub('confirmed_diff', prettyPrintNumber(latest.new_confirmed));
                    sub('confirmed_records', prettyPrintNumber(confirmedRecordCount));
                    sub('confirmed_first', moment(first.date).format('LL'));
                }

                // Hide chart if no new cases in the last window shown
                if (confirmedRecords.slice(-windowSize).reduce((acc, row) => acc + row.new_confirmed, 0) === 0) {
                    $('#no-new-confirmed').show();
                    $('#confirmed-chart').hide();
                    $('#confirmed-summary').hide();
                    $('#report-rolling-confirmed').hide();

                } else {

                    // Latest data for new confirmed case
                    const latest = confirmedRecords.slice(-1)[0] || {};

                    // Load the section chart asynchronously
                    chart(() => {

                        // Put the data in array format
                        const columns = ['date', 'new_confirmed']
                        const chartData = [columns].concat(epi
                            .filter(row => columns.every(col => row[col] !== null))
                            .map(row => columns.slice(0).map(col => row[col]))
                            .slice(-windowSize)
                        );

                        // Prepare and display chart
                        const elem = document.getElementById('confirmed-chart');
                        new google.charts.Bar(elem).draw(
                            google.visualization.arrayToDataTable(chartData),
                            google.charts.Bar.convertOptions({
                                height: chartHeight,
                                colors: ['#1565C0'],
                                hAxis: { title: '' },
                                vAxis: {
                                    viewWindow: { min: 0 },
                                },
                                legend: { position: 'none' },
                            }));
                    });

                    // Compute a rolling sum of the new cases in the last N days
                    const rollingWindowSize = 14;
                    sub('rolling_window', rollingWindowSize);
                    const confirmedRolling = confirmedRecords.map((row, idx) => {
                        const start = Math.max(0, idx - rollingWindowSize);
                        const rollingSum = confirmedRecords.slice(start, idx)
                            .reduce((total, row) => total + row.new_confirmed, 0);
                        return { date: row.date, rolling_confirmed: rollingSum };
                    })

                    // Load the section chart asynchronously
                    chart(() => {

                        // Put the data in array format
                        const columns = ['date', 'rolling_confirmed']
                        const chartData = [columns].concat(confirmedRolling
                            .filter(row => columns.every(col => row[col] !== null))
                            .map(row => columns.slice(0).map(col => row[col]))
                            .slice(-windowSize)
                        );

                        // Prepare and display chart
                        const elem = document.getElementById('rolling-confirmed-chart');
                        new google.charts.Bar(elem).draw(
                            google.visualization.arrayToDataTable(chartData),
                            google.charts.Bar.convertOptions({
                                height: chartHeight,
                                colors: ['#FF9800'],
                                hAxis: { title: '' },
                                vAxis: {
                                    viewWindow: { min: 0 },
                                },
                                legend: { position: 'none' },
                            }));
                    });
                }

                // Hide the section part altogether if we don't have data
                const deceasedRecordCount = epi
                    .map(row => row.new_deceased)
                    .filter(val => val !== null).length;
                if (deceasedRecordCount < minLength) {
                    console.log('Fatalities report not available');
                    $('#report-deaths').hide();

                } else {
                    // Fill out deceased-related data
                    const first = epi.filter(
                        row => row.new_deceased > 0 || row.total_deceased > 0)[0] || {};
                    const latest = epi.filter(
                        row => row.total_deceased || row.new_deceased).slice(-1)[0] || {};
                    sub('deaths_curr', prettyPrintNumber(latest.total_deceased));
                    sub('deaths_diff', prettyPrintNumber(latest.new_deceased));
                    sub('deaths_records', prettyPrintNumber(deceasedRecordCount));
                    sub('deceased_first', moment(first.date).format('LL'));
                }

                // Hide chart if no new cases in the last window shown
                if (epi.slice(-windowSize).reduce((acc, row) => acc + row.new_deceased, 0) === 0) {
                    $('#no-new-deaths').show();
                    $('#deaths-chart').hide();
                    $('#deaths-summary').hide();

                } else {
                    // Load the section chart asynchronously
                    chart(() => {

                        // Put the data in array format
                        const columns = ['date', 'new_deceased']
                        const chartData = [columns].concat(epi
                            .filter(row => columns.every(col => row[col] !== null))
                            .map(row => columns.slice(0).map(col => row[col]))
                            .slice(-windowSize)
                        );

                        // Prepare and display chart
                        const elem = document.getElementById('deaths-chart');
                        new google.charts.Bar(elem).draw(
                            google.visualization.arrayToDataTable(chartData),
                            google.charts.Bar.convertOptions({
                                height: chartHeight,
                                colors: ['#B71C1C'],
                                hAxis: { title: '' },
                                vAxis: {
                                    viewWindow: { min: 0 },
                                },
                                legend: { position: 'none' },
                            }));
                    });
                }
            }

            function onMobilityLoaded(mobility) {

                if (mobility.length > 4) {
                    const latest = mobility[mobility.length - 1];

                    // Show the section if there is mobility data
                    $('#report-mobility').show();

                    // Clean up mobility data by removing empty columns
                    mobility = removeEmptyColumns(mobility);

                    // Load the section chart asynchronously
                    chart(() => {

                        // Put the data in array format
                        const columns = ['date'].concat(Object.keys(mobility[0]).slice(2));
                        const mobilityData = [columns.map(col => col.replace('mobility_', ''))].concat(
                            mobility.map(row => columns.slice(0).map(col => row[col])));

                        // Prepare and display chart
                        const elem = document.getElementById('mobility-chart');
                        new google.visualization.AreaChart(elem).draw(
                            google.visualization.arrayToDataTable(mobilityData), {
                            height: chartHeight,
                            legend: { position: 'in' },
                            hAxis: {
                                slantedText: false,
                            },
                            chartArea: {
                                top: 24,
                                left: 32,
                                width: '90%',
                                height: '80%',
                            }
                        });
                    });
                }

            }

            function onDemographicsLoaded(demographics) {

                // Show the section if there is demographics data
                if (Object.keys(demographics).some(column => demographics[column] != null)) {
                    $('#report-demographics').show();

                    // Create the table
                    $('#table-demographics').html(Object.keys(demographics).map((column, idx) => {
                        return `<tr><td><b>${column}</b></td><td>${prettyPrintNumber(demographics[column])}</td >`;
                    }));
                }

            }
        </script>
    </main>

    <!-- Load analytics at the end of the page -->
    <script src="../templates/analytics.tpl.html" data-include></script>
</body>

</html>