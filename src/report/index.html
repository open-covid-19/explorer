<!DOCTYPE html>
<html>

    <!-- HTML page head -->
    <script src="../templates/head.tpl.html" data-include data-vars='{"root": ".."}'></script>

    <body class="single-column">

        <!-- Header with links -->
        <script src="../templates/header.tpl.html" data-include data-vars='{"root": ".."}'></script>

        <main>
            <!-- Title of the report -->
            <h1 id="report-title" class="centered"><span class="_name"></span> COVID-19 Data</h1>

            <h3 class="centered">Total Confirmed Cases</h3>
            <img id="report-confirmed-image" class="fullwidth" src="../static/transparent.png" />
            <p class="justify">
                The last reported number of confirmed cases is
                <b><span class="_confirmed_curr"></span></b>, which is a difference of
                <b>+<span class="_confirmed_diff"></span></b> from yesterday.
            </p>

            <h3 class="centered">Total Deaths</h3>
            <img id="report-deaths-image" class="fullwidth" src="../static/transparent.png" />
            <p class="justify">
                The latest reports claim a death toll related to COVID-19 of
                <b><span class="_deaths_curr"></span></b>, which is an increase of
                <b>+<span class="_deaths_diff"></span></b> since yesterday.
            </p>

            <div id="report-forecast">
                <h3 class="centered">Confirmed Cases Forecast</h3>
                <img id="report-forecast-image" class="fullwidth" src="../static/transparent.png" />
            </div>

            <!-- Summary of the report: more cases expected -->
            <p id="report-summary-more" class="justify" style="display: none;">
                The forecast shows an expected increase in number of confirmed COVID-19 cases to a total
                of <b><span class="_confirmed_pred"></span> (+<span class="_pred_percent"></span>%)
                </b> over the next <span class="_pred_days"></span> days. Forecasting is done by
                fitting the data to a <a href="https://en.wikipedia.org/wiki/Gompertz_function" target="_blank">
                Gompertz curve</a>, see the <a href="../about">about page</a> for more details.
            </p>

            <!-- Summary of the report: same cases expected -->
            <p id="report-summary-same" class="justify" style="display: none;">
                The forecast shows less than 1% increase of new cases of confirmed COVID-19 cases
                over the next <span class="_pred_days"></span> days. Forecasting is done by
                fitting the data to a <a href="https://en.wikipedia.org/wiki/Gompertz_function" target="_blank">
                Gompertz curve</a>, see the <a href="../about">about page</a> for more details.
            </p>

            <div id="report-region" style="display: none;">
                <h3 class="centered">Regional Data</h3>
                <p class="justify">
                    Please see below for a list of regions for which data is individually reported.
                </p>
                <ul id="region-list"></ul>
            </div>


            <!-- Footnote of the report -->
            <p id="report-summary-footnote" class="justify" style="font-size: small;">
                NOTE: The dates in the data reflects the reported date, which is at least one day
                behind the live data. Please see the <a href="../about/">about page</a> for more
                information.
            </p>

            <!-- Setup report data -->
            <script>

                loadData(data => {
                    window.data = data
                    const code = URLSearchParameters().code;
                    let dataFilter;
                    if (code.indexOf('_') !== -1) {
                        const parts = code.split('_');
                        dataFilter = row => row.RegionCode === parts[1] && row.CountryCode === parts[0];
                    } else {
                        dataFilter = row => !row.RegionCode && row.CountryCode === code;
                    }
                    const latest = data.world.filter(dataFilter)[0];
                    const history = data.history.filter(dataFilter);
                    const forecast = data.forecast.filter(dataFilter);
                    const chartEntry = data.charts[code];
                    const chartUrl = key => `${OPEN_COVID_19_URL}/data/charts/${chartEntry[key]}`;

                    chartEntry.Confirmed && $('#report-confirmed-image').attr('src', chartUrl('Confirmed'));
                    chartEntry.Deaths && $('#report-deaths-image').attr('src', chartUrl('Deaths'));

                    const sub = (klass, text) =>
                        $(`._${klass}`).each(function() { $(this).text(text) });

                    sub('name', latest.RegionName || latest.CountryName)
                    sub('confirmed_curr', latest.Confirmed)
                    sub('confirmed_diff',
                        history[history.length - 1].Confirmed - history[history.length - 2].Confirmed)
                    sub('deaths_curr', latest.Deaths)
                    sub('deaths_diff',
                        history[history.length - 1].Deaths - history[history.length - 2].Deaths)

                    const otherRegions = data.world
                        .filter(row => row.RegionCode && row.CountryCode == code)
                        .sort((a, b) => a.RegionName.localeCompare(b.RegionName));
                    if (otherRegions.length > 1) {
                        $('#report-region').show();
                        $('#region-list').html(otherRegions.map(row => {
                            return `<li><a href="?code=${row.CountryCode}_${row.RegionCode}">${row.RegionName}</a></li>`
                        }))
                    }

                    // Fill out prediction-related data
                    try {
                        // Hide the forecast part altogether if we don't have a chart
                        if (!chartEntry.Forecast) $('#report-forecast').hide();

                        const recordedLast = latest.Confirmed;
                        const estimatedLast = forecast[forecast.length - 1].Estimated;
                        const totalIncrease = estimatedLast - recordedLast;
                        const percentIncrease = 100 * (totalIncrease / recordedLast);
                        const estimatedDays = forecast.filter(row => row.Confirmed === null).length;

                        sub('pred_days', estimatedDays)
                        sub('pred_percent', percentIncrease.toFixed(2))
                        sub('confirmed_pred', estimatedLast.toFixed(0))
                        $('#report-forecast-image').attr('src', chartUrl('Forecast'));

                        if (percentIncrease < 1) {
                            $('#report-summary-same').show();
                        } else {
                            $('#report-summary-more').show();
                        }

                    } catch (exc) {
                        console.log(exc);
                    }
               });
            </script>
        </main>

        <!-- Load analytics at the end of the page -->
        <script src="../templates/analytics.tpl.html" data-include></script>
    </body>
</html>