<!-- Wrap the whole widget into a DIV -->
<div id="age-stratified-active-cases" style="visibility: hidden;">
    <p style="text-align: end; font-size: small;">
        Infection rates are computed as the 14-day rolling sum of cases per 1,000
    </p>
    <div class="spacer"></div>
    <div class="spacer"></div>

    <script async>!async function(){const e=["age_bin_0","age_bin_1","age_bin_2","age_bin_3","age_bin_4","age_bin_5","age_bin_6","age_bin_7","age_bin_8","age_bin_9","new_confirmed_age_0","new_confirmed_age_1","new_confirmed_age_2","new_confirmed_age_3","new_confirmed_age_4","new_confirmed_age_5","new_confirmed_age_6","new_confirmed_age_7","new_confirmed_age_8","new_confirmed_age_9","population_age_00_09","population_age_10_19","population_age_20_29","population_age_30_39","population_age_40_49","population_age_50_59","population_age_60_69","population_age_70_79","population_age_80_and_older"],a=document.currentScript.parentElement,n=new URLSearchParams(location.search).get("key");let _=await loadLocationData(n);const o=["age_bin_0","new_confirmed_age_0","population_age_00_09"];if(_.filter(e=>o.every(a=>e[a]&&""!==e[a])).length<34)return console.error("Not enough records found for columns:",o),void(a.style.display="none");const t=e.filter(e=>e.startsWith("new_confirmed_age_")),i=e.filter(e=>!e.startsWith("age_bin_"));_=mapToNumeric(_,i,!0);const r=new Set(filterDataIndices(_,14,t)),c=(e=>Object.keys(e).filter(e=>e.startsWith("age_bin_")).map(a=>e[a]))((_=_.filter((e,a)=>r.has(a)).filter(a=>e.some(e=>!Number.isNaN(a[e])))).slice(-7)[0]).reduce((e,a,n)=>{const[_,o]=a.split("-",2).map(e=>parseInt(e));return _%10!=0||o!==_+9&&o!==_+10?80!==_&&90!==_||!Number.isNaN(o)||(e[a]=`population_age_${_}_and_older`):e[a]=`population_age_${_}_${_+9}`,e},{"80-":"population_age_80_and_older"}),l=_.reduce((a,n)=>(e.forEach(e=>{const _=`age_bin_${e.split("_").slice(-1)[0]}`;n[_]&&(a[e]=n[_])}),a),{}),s=_.map((e,a)=>{const n={Date:e.date},o=Math.max(0,a-14);t.forEach(t=>{const i=l[t];if(e[t]){const e=_.slice(o,a).reduce((e,a)=>e+(parseInt(a[t])||0),0);n[i]=e}else i&&(n[i]=Number.NaN)});const i=Object.keys(c).map(e=>c[e]);return i.includes("population_age_80_89")&&i.includes("population_age_90_and_older")&&(n["80-"]=n["80-89"]+n["90-"],delete n["80-89"],delete n["90-"]),Object.keys(n).slice(1).forEach(a=>{c[a]?n[a]=1e3*n[a]/e[c[a]]:delete n[a]}),n}).slice(14);if(!s.every(e=>Object.keys(e).length>1))return console.error("Age bins for cases do not match population buckets:",l),void(a.style.display="none");await loadGoogleCharts(["corechart"]);const g=attachElement("div",{},a,!0);new google.visualization.LineChart(g).draw(recordsToDataTable(s),Object.assign({},GOOGLE_CHARTS_CONFIG,{title:chartLabel("Infection rates by age group"),curveType:"function",legend:{position:"in"},colors:void 0,interpolateNulls:!0})),a.style.visibility="visible",document.querySelector("#active-cases").style.display="none"}();</script>
</div>